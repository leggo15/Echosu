{% extends 'base.html' %}
{% load static %}

{% block title %}Tag Library{% endblock %}
{% block head_css %}
  <link rel="stylesheet" href="{% static 'css/tag_library.css' %}">
{% endblock %}
{% block content %}
    <div class="container">

        <!-- Top Tags Section -->
        <section class="tags-usage">
            <h2>Top 50 Tags</h2>
            <div class="top-tags">
                {% for tag in top_tags %}
                    <a 
                        href="{% url 'search_results' %}?query={{ '"'|add:tag.name|add:'"'|urlencode }}"
                        class="tag-pill"
                        aria-label="Search results for tag {{ tag.name }}"
                    >
                        <span class="pill-name">{{ tag.name }} </span>
                        <span class="pill-count">({{ tag.map_count }})</span>
                    </a>
                {% empty %}
                    <p>No tags available.</p>
                {% endfor %}
            </div>
        </section>  


        <h1>Tag Library</h1>
        <input type="text" id="tag-search" class="search-field" placeholder="Search tags..." aria-label="Search Tags" />
        <ul class="tag-list" id="tag-list">
            {% for tag in tags %}
                <li class="tag-item">
                    <a href="{% url 'search_results' %}?query={{ '"'|add:tag.name|add:'"'|urlencode }}" 
                       class="tag-link" 
                       aria-label="Search results for tag {{ tag.name }}">
                        <span class="tag-name" 
                              data-description="{{ tag.description|escapejs }}" 
                              data-description-author="{{ tag.description_author|escapejs }}">
                            {{ tag.name }}
                        </span>
                        <span class="tag-count">
                            {% if tag.beatmap_count > 0 %}
                                {{ tag.beatmap_count }} {{ tag.beatmap_count|pluralize:"beatmap,beatmaps" }}
                            {% else %}
                                No beatmaps
                            {% endif %}
                        </span>
                    </a>
                </li>
            {% empty %}
                <li class="no-tags-message">No tags available.</li>
            {% endfor %}
        </ul>
    </div>

    <script>
        $(document).ready(function(){
            // Function to highlight matching text
            function highlightMatch(text, query) {
                if (!query) return text;
                var regex = new RegExp('(' + query + ')', 'gi');
                return text.replace(regex, '<span class="highlight">$1</span>');
            }

            // Debounce function to limit the rate of function execution
            function debounce(func, delay) {
                let debounceTimer;
                return function() {
                    const context = this;
                    const args = arguments;
                    clearTimeout(debounceTimer);
                    debounceTimer = setTimeout(() => func.apply(context, args), delay);
                }
            }

            // Event listener for search input with debounce
            $('#tag-search').on('input', debounce(function(){
                var query = $(this).val().toLowerCase();
                var hasVisibleTags = false;

                $('#tag-list .tag-item').each(function(){
                    var tagLink = $(this).find('.tag-link');
                    var tagNameElement = tagLink.find('.tag-name');
                    var tagName = tagNameElement.text().toLowerCase();

                    if(tagName.includes(query)){
                        // Highlight the matching part
                        var originalText = tagNameElement.text();
                        var highlightedText = highlightMatch(originalText, query);
                        tagNameElement.html(highlightedText);
                        $(this).show();
                        hasVisibleTags = true;
                    } else {
                        // Remove any existing highlights and hide the tag
                        var originalText = tagNameElement.text();
                        tagNameElement.text(originalText);
                        $(this).hide();
                    }
                });

                // Show 'No matching tags found.' message if applicable
                if(query.length > 0 && !hasVisibleTags){
                    if($('#tag-list .no-results').length === 0){
                        $('#tag-list').append('<li class="no-tags-message no-results">No matching tags found.</li>');
                    }
                } else {
                    $('#tag-list .no-tags-message.no-results').remove();
                }
            }, 300)); // 300ms delay

            // Tooltip functionality
            // Note: tooltips for .tag-name can be handled by a dedicated JS if needed later
        });
    </script>
{% endblock %}
