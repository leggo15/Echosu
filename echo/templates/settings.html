{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Settings</title>
    <link rel="stylesheet" href="{% static 'css/master.css' %}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="{% static 'js/master.js' %}"></script>
    <style>
        /* Existing Styles ... */

        /* Styles for the collapsible header */
        .collapsible-header {
            cursor: pointer;
            padding: 10px;
            background-color: #f1f1f1;
            border: none;
            text-align: left;
            outline: none;
            font-size: 18px;
            transition: background-color 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Change background color when active */
        .collapsible-header.active {
            background-color: #ccc;
        }

        /* Styles for the arrow indicator */
        .collapsible-header .arrow {
            transition: transform 0.3s;
        }

        /* Rotate the arrow when active */
        .collapsible-header.active .arrow {
            transform: rotate(180deg);
        }

        /* Styles for the collapsible content */
        .collapsible-content {
            display: none;
            padding: 0 15px;
            border-left: 2px solid #f1f1f1;
            border-right: 2px solid #f1f1f1;
            border-bottom: 2px solid #f1f1f1;
            margin-bottom: 20px;
        }

        /* Optional: Add some transition for smoothness */
        .collapsible-content.show {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from {opacity: 0;}
            to {opacity: 1;}
        }

        /* Styles for individual API Key containers */
        .api-key-container {
            padding: 10px 0;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .api-key-details {
            flex-grow: 1;
        }

        /* Optional: Style the rename form */
        .rename-form {
            margin-top: 10px;
        }

        .rename-form input[type="text"], .edit-input {
            padding: 5px;
            font-size: 16px;
            width: 60%;
            margin-right: 10px;
        }

        .save-button {
            padding: 5px 10px;
            margin-left: 10px;
        }

        .cancel-button {
            padding: 5px 10px;
            margin-left: 5px;
        }

        /* Styles for editable API key names */
        .api-key-name {
            cursor: pointer;
            padding: 5px;
            display: inline-block;
        }

        .api-key-name:hover {
            background-color: #eaeaea;
        }

        /* Styles for delete button */
        .delete-button {
            background-color: #ff4d4d;
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 3px;
            transition: background-color 0.3s;
        }

        .delete-button:hover {
            background-color: #ff1a1a;
        }

        /* Responsive Design */
        @media (max-width: 600px) {
            .rename-form input[type="text"], .edit-input {
                width: 100%;
                margin-bottom: 10px;
            }

            .save-button, .cancel-button, .delete-button {
                width: 100%;
                margin: 5px 0;
            }

            .api-key-container {
                flex-direction: column;
                align-items: flex-start;
            }
        }

        /* Styles for messages */
        .messages {
            list-style: none;
            padding: 0;
            margin: 10px 0;
        }

        .messages li {
            padding: 10px;
            margin-bottom: 5px;
            border-radius: 4px;
        }

        .messages li.success {
            background-color: #d4edda;
            color: #155724;
        }

        .messages li.error {
            background-color: #f8d7da;
            color: #721c24;
        }

        /* Styles for Data Deletion Section */
        .data-deletion-section {
            margin-top: 40px;
            padding: 20px;
            background-color: #fff0f0;
            border: 1px solid #ffcccc;
            border-radius: 5px;
        }

        .data-deletion-section h2 {
            color: #cc0000;
        }

        .delete-data-btn {
            background-color: #cc0000;
            color: white;
            border: none;
            padding: 12px 20px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .delete-data-btn:hover {
            background-color: #a30000;
        }
    </style>
    <script>
        $(document).ready(function(){
            // Toggle the collapsible content when header is clicked
            $('.collapsible-header').click(function(){
                $(this).toggleClass('active');
                $(this).find('.arrow').toggleClass('rotated');
                $(this).next('.collapsible-content').toggleClass('show');
            });

            // Handle double-click on API key name to enable editing
            $('.api-key-name').dblclick(function(){
                var currentElement = $(this);
                var alreadyEditing = $('.edit-input').length > 0;

                if(alreadyEditing){
                    alert('Please finish editing the current API key before editing another.');
                    return;
                }

                var currentName = currentElement.text().trim();
                var apiKeyId = currentElement.data('api-key-id');

                // Create an input field with the current name
                var inputField = $('<input>', {
                    type: 'text',
                    class: 'edit-input',
                    value: currentName
                });

                // Create Save and Cancel buttons
                var saveButton = $('<button>', {
                    type: 'button',
                    class: 'save-button',
                    text: 'Save'
                });

                var cancelButton = $('<button>', {
                    type: 'button',
                    class: 'cancel-button',
                    text: 'Cancel'
                });

                // Replace the name text with the input field and buttons
                currentElement.hide();
                currentElement.after(inputField, saveButton, cancelButton);

                // Focus on the input field
                inputField.focus();

                // Handle Save button click
                saveButton.click(function(){
                    var newName = inputField.val().trim();
                    if(newName === ''){
                        alert('API Key name cannot be empty.');
                        inputField.focus();
                        return;
                    }

                    // Submit the form with the new name
                    var form = $('<form>', {
                        method: 'POST',
                        action: '{% url "settings" %}'
                    });

                    // Add CSRF token
                    var csrfToken = '{{ csrf_token }}';
                    form.append($('<input>', {
                        type: 'hidden',
                        name: 'csrfmiddlewaretoken',
                        value: csrfToken
                    }));

                    // Add api_key_id and new key_name
                    form.append($('<input>', {
                        type: 'hidden',
                        name: 'api_key_id',
                        value: apiKeyId
                    }));
                    form.append($('<input>', {
                        type: 'hidden',
                        name: 'key_name',
                        value: newName
                    }));

                    // Append the form to the body and submit
                    $('body').append(form);
                    form.submit();
                });

                // Handle Cancel button click
                cancelButton.click(function(){
                    inputField.remove();
                    saveButton.remove();
                    cancelButton.remove();
                    currentElement.show();
                });

                // Optional: Handle Enter key to save
                inputField.keypress(function(e){
                    if(e.which == 13){ // Enter key
                        saveButton.click();
                    }
                });
            });

            // Handle Delete button click for API keys
            $('.delete-button').click(function(){
                var deleteButton = $(this);
                var apiKeyId = deleteButton.data('api-key-id');
                var apiKeyName = deleteButton.data('api-key-name');

                if(confirm('Are you sure you want to delete the API Key "' + apiKeyName + '"? This action cannot be undone.')){
                    // Create a form to submit the delete request
                    var form = $('<form>', {
                        method: 'POST',
                        action: '{% url "settings" %}'
                    });

                    // Add CSRF token
                    var csrfToken = '{{ csrf_token }}';
                    form.append($('<input>', {
                        type: 'hidden',
                        name: 'csrfmiddlewaretoken',
                        value: csrfToken
                    }));

                    // Add delete_key and api_key_id
                    form.append($('<input>', {
                        type: 'hidden',
                        name: 'delete_key',
                        value: '1' // Identifier for delete action
                    }));
                    form.append($('<input>', {
                        type: 'hidden',
                        name: 'api_key_id',
                        value: apiKeyId
                    }));

                    // Append the form to the body and submit
                    $('body').append(form);
                    form.submit();
                }
            });

            // Handle Delete All Data button click
            $('.delete-data-btn').click(function(){
                if(confirm('Are you sure you want to delete all your data? This action cannot be undone.')){
                    // Redirect to the confirmation page
                    window.location.href = '{% url "confirm_data_deletion" %}';
                }
            });

        });
    </script>
</head>
<body>
    {% include '_navbar.html' %}

    <div class="container">
        <div class="settings-page">
            <h1>Settings</h1>

            <!-- Display messages -->
            {% if messages %}
                <ul class="messages">
                    {% for message in messages %}
                        <li class="{{ message.tags }}">{{ message }}</li>
                    {% endfor %}
                </ul>
            {% endif %}

            {% if full_key %}
                <div class="api-key-notice">
                    <p><strong>New API Key:</strong> <span class="api-key">{{ full_key }}</span></p>
                    <p class="important-note">Make sure to copy your API key now. You won't be able to see it again.</p>
                </div>
            {% endif %}

            <!-- API Keys Section -->
            <div class="api-keys-section">
                <!-- Collapsible Header -->
                <button class="collapsible-header" aria-expanded="false" aria-controls="api-keys-content">
                    API Keys
                    <span class="arrow">&#9660;</span> <!-- Down arrow -->
                </button>

                <!-- Collapsible Content -->
                <div class="collapsible-content" id="api-keys-content" aria-hidden="true">
                    <br>
                    <!-- Form to generate a new API key -->
                    <form method="POST" class="api-key-form">
                        {% csrf_token %}
                        <button type="submit" name="generate_key" class="btn">Generate New API Key</button>
                    </form>
                    {% if api_keys %}
                        {% for api_key in api_keys %}
                            <div class="api-key-container">
                                <div class="api-key-details">
                                    <h3>
                                        <span class="api-key-name" data-api-key-id="{{ api_key.id }}">
                                            {{ api_key.key_name|default:"API Key" }}
                                        </span>
                                    </h3>
                                    <p><strong>Prefix:</strong> {{ api_key.prefix }}</p>
                                    <p><strong>Creation Date:</strong> {{ api_key.created }}</p>
                                </div>
                                <div class="api-key-actions">
                                    <!-- Delete Button -->
                                    <button type="button" class="delete-button" data-api-key-id="{{ api_key.id }}" data-api-key-name="{{ api_key.key_name|default:"API Key" }}">
                                        Delete
                                    </button>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <p>You do not have any API keys yet.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Data Deletion Section -->
            <div class="data-deletion-section">
                <h2>Delete All Your Data</h2>
                <p>If you wish to delete all your contributions and data from our site, you can do so by clicking the button below. This action is irreversible.</p>
                <button type="button" class="delete-data-btn">Delete All My Data</button>
            </div>

        </div>
    </div>
</body>
</html>
