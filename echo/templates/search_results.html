{% extends 'base.html' %}
{% load static %}

{% block title %}Search Results{% endblock %}
{% block body_class %}page-search-results{% endblock %}

{% block head_css %}
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
  <link rel="stylesheet" href="{% static 'css/beatmap_card.css' %}">
  <link rel="stylesheet" href="{% static 'css/tagging.css' %}">
  <link rel="stylesheet" href="{% static 'css/search_filters.css' %}">
{% endblock %}

{% block content %}
    <meta name="csrf-token" content="{{ csrf_token }}">

        <h2 class="collapsible-description-header" aria-expanded="false" aria-controls="add-beatmap-content" role="button" tabindex="0">
            Advanced Search
            <span class="arrow">&#9660;</span> <!-- Down arrow -->
        </h2>
        <div class="collapsible-description-content" id="add-beatmap-content" aria-hidden="true">
            <p>
                Use the search box to find beatmaps by <strong>tags</strong>, <strong>song genre</strong>, <strong>mapper</strong>, <strong>artist</strong> etc. Refine your results with the following filters:
            </p>
            <ul>
                <li><strong>Star Rating:</strong> Adjust the slider to set the minimum and maximum Star rating.</li>
                <li><strong>Status:</strong> Select one or more statuses: Ranked, Loved, Unranked (Unranked includes everything not found in Ranked or Loved).</li>
                <li><strong>Game Mode:</strong> Choose from osu!, Taiko, Catch the Beat, or osu!mania.</li>
            </ul>
            <p><strong>Advanced Search Operators:</strong></p>
            <ul>
                <li>
                    <strong>Keywords:</strong>
                    Keywords are words the search engine can recognize, these include <strong>tags</strong>, <strong>song genre</strong>, <strong>song name</strong>, <strong>diffulty name</strong>, <strong>mapper</strong>, <strong>artist</strong>.
                </li>
                <li>
                    <strong>Multi-Word Tags:</strong>
                    Enclose phrases in quotes to search specifically for tags consisting of more than one word.
                    <ul>
                        <li><em>Example:</em> <code>"spaced streams"</code></li>
                    </ul>
                </li>
                <li>
                    <strong>Remove from Search:</strong>
                    By adding a minus symbol in front of a tag, the search engine will only look for maps without these tags.
                    <ul>
                        <li><em>Example:</em> <code>-farm</code></li>
                    </ul>
                </li>
                <li>
                    <strong>Add Required Tag:</strong>
                    By adding a dot symbol in front of a tag, the search engine will guarantee that all results contain this tag.
                    <ul>
                        <li><em>Example:</em> <code>.farm</code></li>
                    </ul>
                </li>
                <li>
                    <strong>Attribute Filters:</strong>
                    Use operators to filter specific attributes.
                    <ul>
                        <li><em>Examples:</em>
                            <ul>
                                <li><code>AR=8</code></li>
                                <li><code>OD&gt;8</code></li>
                                <li><code>CS&lt;6</code></li>
                                <li><code>BPM&gt;=170</code></li>
                                <li><code>LENGTH&gt;=200(in seconds)</code></li>
                                <li><code>FAV&lt;=30</code></li>
                                <li><code>COUNT&gt;10000</code></li>
                                 <li><code>PP&gt;=300 PP&lt;=350</code></li>
                            </ul>
                        </li>
                    </ul>
                </li>
                <li>
                    <strong>Combine Terms:</strong>
                    Mix keywords and operators for precise searches.
                    <ul>
                        <li><em>Example:</em><code> tech ."awkward aim" -"large sliders" -bursts -streams AR&lt;=9.5 OD&gt;8 CS&gt;4.5 BPM&gt;=190 BPM&lt;=200</code></li>
                    </ul>
                </li>
            </ul>
        </div>
        
        
        <!-- Search form with additional filters -->
        <form action="{% url 'search_results' %}" method="get" class="beatmap-form filters-card">
            <div class="filters-grid filters-grid--tight">

                <!-- Star Rating Slider (slightly narrower) -->
                <div class="filter-item slider-container">
                    <label for="star-rating">Star Rating:</label>
                    <div id="star-rating-slider"></div>
                    <div class="slider-labels">
                        <span id="star-rating-min">0</span>
                        <span id="star-rating-max">10+</span>
                    </div>
                    <input type="hidden" name="star_min" id="star_min" value="{{ request.GET.star_min|default:0 }}">
                    <input type="hidden" name="star_max" id="star_max" value="{{ request.GET.star_max|default:10 }}">
                    <input type="hidden" name="sort" id="main-sort" value="{{ request.GET.sort }}">
                </div>

                <!-- Add status filter toggle buttons -->
                <div class="filter-status">
                    <label>Status:</label>
                    <div class="status-toggles">
                        <label>
                            <input type="checkbox" name="status_ranked" value="ranked" {% if status_ranked %}checked{% endif %}>
                            <span>Ranked</span>
                        </label>
                        <label>
                            <input type="checkbox" name="status_loved" value="loved" {% if status_loved %}checked{% endif %}>
                            <span>Loved</span>
                        </label>
                        <label>
                            <input type="checkbox" name="status_unranked" value="unranked" {% if status_unranked %}checked{% endif %}>
                            <span>Unranked</span>
                        </label>
                    </div>
                </div>

                <!-- Include predicted tags dropdown -->
                <div class="filter-mode">
                    <label for="include_predicted">Predicted Tags:</label>
                    <select name="include_predicted" id="include_predicted">
                        <option value="include" {% if include_predicted == 'include' or not include_predicted %}selected{% endif %}>Include</option>
                        <option value="exclude" {% if include_predicted == 'exclude' %}selected{% endif %}>Exclude</option>
                        <option value="only" {% if include_predicted == 'only' %}selected{% endif %}>Only</option>
                    </select>
                </div>

                <!-- Exclude player's maps dropdown -->
                <div class="filter-mode">
                    <label for="exclude_player">Exclude My:</label>
                    <select name="exclude_player" id="exclude_player">
                        <option value="none" {% if request.GET.exclude_player == 'none' or not request.GET.exclude_player %}selected{% endif %}>None</option>
                        <option value="top" {% if request.GET.exclude_player == 'top' %}selected{% endif %}>Top plays</option>
                        <option value="fav" {% if request.GET.exclude_player == 'fav' %}selected{% endif %}>osu! Favorites</option>
                    </select>
                </div>


                <!-- Game Mode Selection -->
                <div class="filter-mode">
                    <label for="mode">Game Mode:</label>
                    <select name="mode" id="mode">
                        <option value="osu" {% if not request.GET.mode or request.GET.mode == "osu" %}selected{% endif %}>osu!</option>
                        <option value="taiko" {% if request.GET.mode == "taiko" %}selected{% endif %}>Taiko</option>
                        <option value="catch" {% if request.GET.mode == "catch" %}selected{% endif %}>Catch the Beat</option>
                        <option value="mania" {% if request.GET.mode == "mania" %}selected{% endif %}>osu!mania</option>
                    </select>
                </div>

            </div>
            <div class="search-row">
                <input type="text" class="search-input" name="query" id="tag-input" placeholder="Search by Tags, song genre, name, mapper, artist and more..." value="{{ request.GET.query }}">
                <button type="submit" class="search-btn">Search</button>
            </div>
        </form>

        <form method="get" action="{% url 'search_results' %}" class="sorting-form">
            <!-- Preserve existing GET parameters -->
            <input type="hidden" name="query" value="{{ query }}">
            <input type="hidden" name="mode" value="{{ request.GET.mode }}">
            <input type="hidden" name="star_min" value="{{ star_min }}">
            <input type="hidden" name="star_max" value="{{ star_max }}">
            <input type="hidden" name="include_predicted" value="{{ include_predicted }}">
            <input type="hidden" name="exclude_player" value="{{ request.GET.exclude_player }}">
            {% if status_ranked %}
                <input type="hidden" name="status_ranked" value="ranked">
            {% endif %}
            {% if status_loved %}
                <input type="hidden" name="status_loved" value="loved">
            {% endif %}
            {% if status_unranked %}
                <input type="hidden" name="status_unranked" value="unranked">
            {% endif %}
            
            <label for="sort">Sort by:</label>
            <select name="sort" id="sort" onchange="document.getElementById('main-sort').value=this.value; document.querySelector('form.beatmap-form').submit();">
                <option value="tag_weight" {% if sort == 'tag_weight' %}selected{% endif %}>Tag Weight</option>
                <option value="popularity" {% if sort == 'popularity' %}selected{% endif %}>Popularity</option>
            </select>
        </form>


        <div class="search-results">
          {% for beatmap in beatmaps %}
            {% include 'partials/tag_card.html' with beatmap=beatmap %}
          {% empty %}
            <p>No results found.</p>
          {% endfor %}
        </div>

    <!-- Pagination Controls -->
    <div class="pagination">
        <span class="step-links">
            {% if beatmaps.has_previous %}
                <a href="?query={{ query|urlencode }}&mode={{ request.GET.mode }}&star_min={{ star_min }}&star_max={{ star_max }}&sort={{ sort }}{% if status_ranked %}&status_ranked=ranked{% endif %}{% if status_loved %}&status_loved=loved{% endif %}{% if status_unranked %}&status_unranked=unranked{% endif %}&include_predicted={{ request.GET.include_predicted }}&exclude_player={{ request.GET.exclude_player }}&page=1">&laquo; first</a>
                <a href="?query={{ query|urlencode }}&mode={{ request.GET.mode }}&star_min={{ star_min }}&star_max={{ star_max }}&sort={{ sort }}{% if status_ranked %}&status_ranked=ranked{% endif %}{% if status_loved %}&status_loved=loved{% endif %}{% if status_unranked %}&status_unranked=unranked{% endif %}&include_predicted={{ request.GET.include_predicted }}&exclude_player={{ request.GET.exclude_player }}&page={{ beatmaps.previous_page_number }}">previous</a>
            {% endif %}

            <span class="current">
                Page {{ beatmaps.number }} of {{ beatmaps.paginator.num_pages }}.
            </span>

            {% if beatmaps.has_next %}
                <a href="?query={{ query|urlencode }}&mode={{ request.GET.mode }}&star_min={{ star_min }}&star_max={{ star_max }}&sort={{ sort }}{% if status_ranked %}&status_ranked=ranked{% endif %}{% if status_loved %}&status_loved=loved{% endif %}{% if status_unranked %}&status_unranked=unranked{% endif %}&include_predicted={{ request.GET.include_predicted }}&exclude_player={{ request.GET.exclude_player }}&page={{ beatmaps.next_page_number }}">next</a>
                <a href="?query={{ query|urlencode }}&mode={{ request.GET.mode }}&star_min={{ star_min }}&star_max={{ star_max }}&sort={{ sort }}{% if status_ranked %}&status_ranked=ranked{% endif %}{% if status_loved %}&status_loved=loved{% endif %}{% if status_unranked %}&status_unranked=unranked{% endif %}&include_predicted={{ request.GET.include_predicted }}&exclude_player={{ request.GET.exclude_player }}&page={{ beatmaps.paginator.num_pages }}">last &raquo;</a>
            {% endif %}
        </span>
    </div>

{% endblock %}

{% block foot_js %}
  <script src="{% static 'js/search_filters.js' %}"></script>
  <script src="{% static 'js/tagging.js' %}"></script>
  <script src="{% static 'js/collapsible_descriptions.js' %}"></script>
  <script>
    (function() {
      var sortSelect = document.getElementById('sort');
      var mainSort = document.getElementById('main-sort');
      var mainForm = document.querySelector('form.beatmap-form');
      var queryInput = document.getElementById('tag-input');
      if (!sortSelect || !mainSort || !mainForm) return;
      var sortTouched = false;
      var initialQuery = (queryInput && queryInput.value) ? queryInput.value : '';
      sortSelect.addEventListener('change', function() {
        sortTouched = true;
        mainSort.value = sortSelect.value;
      });
      mainForm.addEventListener('submit', function() {
        var currentQuery = (queryInput && queryInput.value) ? queryInput.value : '';
        if (sortTouched) {
          mainSort.value = sortSelect.value;
        } else {
          // If transitioning from empty query to non-empty, let backend choose default (clear sort)
          if (initialQuery.trim() === '' && currentQuery.trim() !== '') {
            mainSort.value = '';
          }
          // else: keep whatever came from URL so user's prior explicit choice persists
        }
      });
    })();
  </script>
{% endblock %}
