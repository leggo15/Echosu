{% extends 'base.html' %}
{% load static %}

{% block title %}Tag Library{% endblock %}
{% block head_css %}
  <link rel="stylesheet" href="{% static 'css/tag_library.css' %}">
{% endblock %}
{% block content %}
    <div class="container">

        <!-- Top Tags Section -->
        <section class="tags-usage">
            <h2>Top 50 Tags</h2>
            <div class="top-tags">
                {% for tag in top_tags %}
                    <a 
                        href="{% url 'search_results' %}?query={{ '"'|add:tag.name|add:'"'|urlencode }}"
                        class="tag-pill"
                        data-name="{{ tag.name|lower }}"
                        aria-label="Search results for tag {{ tag.name }}"
                    >
                        <span class="pill-name">{{ tag.name }} </span>
                        <span class="pill-count">({{ tag.map_count }})</span>
                    </a>
                {% empty %}
                    <p>No tags available.</p>
                {% endfor %}
            </div>
        </section>  


        <h1>Tag Library</h1>
        <input type="text" id="tag-search" class="search-field" placeholder="Search tags..." aria-label="Search Tags" />
        <ul class="tag-list" id="tag-list">
            {% for tag in tags %}
                <li class="tag-item" data-name="{{ tag.name|lower }}">
                    <a href="{% url 'search_results' %}?query={{ '"'|add:tag.name|add:'"'|urlencode }}" 
                       class="tag-link" 
                       aria-label="Search results for tag {{ tag.name }}">
                        <span class="tag-name" 
                              data-description="{{ tag.description|escapejs }}" 
                              data-description-author="{{ tag.description_author_username|default_if_none:'N/A'|escapejs }}">
                            {{ tag.name }}
                        </span>
                        <span class="tag-count">
                            {% if tag.beatmap_count > 0 %}
                                {{ tag.beatmap_count }} {{ tag.beatmap_count|pluralize:"beatmap,beatmaps" }}
                            {% else %}
                                No beatmaps
                            {% endif %}
                        </span>
                    </a>
                </li>
            {% empty %}
                <li class="no-tags-message">No tags available.</li>
            {% endfor %}
        </ul>

        <!-- Contributors Leaderboard -->
        <section class="contributors-leaderboard" aria-labelledby="contributors-heading">
            <h2 id="contributors-heading">Top Contributors</h2>
            <div class="leaderboard">
                <table class="leaderboard-table">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Tag Applications</th>
                            <th>Unique Maps Tagged</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if current_user_stats %}
                            <tr class="current-user-row">
                                <td>{{ current_user_stats.username|default:'You' }}</td>
                                <td>{{ current_user_stats.tag_count }}</td>
                                <td>{{ current_user_stats.unique_maps }}</td>
                            </tr>
                            <tr><td colspan="3"><hr></td></tr>
                        {% endif %}
                        {% for row in leaderboard %}
                            <tr>
                                <td>{{ row.user__username|default:'Anonymous' }}</td>
                                
                                <td>{{ row.tag_count }}</td>
                                <td>{{ row.unique_maps }}</td>
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="3">No contributions yet.</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </section>
    </div>
{% endblock %}

{% block foot_js %}
<script>
    $(document).ready(function(){
        // Escape user input for safe regex usage
        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        // Function to highlight matching text
        function highlightMatch(text, escapedQuery) {
            if (!escapedQuery) return text;
            var regex = new RegExp('(' + escapedQuery + ')', 'gi');
            return text.replace(regex, '<span class="highlight">$1</span>');
        }

        // Debounce function to limit the rate of function execution
        function debounce(func, delay) {
            let debounceTimer;
            return function() {
                const context = this;
                const args = arguments;
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => func.apply(context, args), delay);
            }
        }

        // Preserve original text for highlight reset
        $('.tag-name').each(function(){
            $(this).attr('data-original', $(this).text());
        });
        $('.pill-name').each(function(){
            $(this).attr('data-original', $(this).text());
        });

        function applyFilter(rawQuery){
            var query = (rawQuery || '').toLowerCase();
            var escaped = escapeRegExp(query);
            var hasVisibleTags = false;
            var hasVisibleTop = false;

            // Filter main tag list
            $('#tag-list .tag-item').each(function(){
                var itemName = ($(this).attr('data-name') || '').toLowerCase();
                var tagNameElement = $(this).find('.tag-name');
                var originalText = tagNameElement.attr('data-original') || tagNameElement.text();
                if(!query || itemName.includes(query)){
                    tagNameElement.html(query ? highlightMatch(originalText, escaped) : originalText);
                    $(this).show();
                    hasVisibleTags = true;
                } else {
                    tagNameElement.html(originalText);
                    $(this).hide();
                }
            });

            // Optionally filter top tags as well for consistency
            $('.top-tags .tag-pill').each(function(){
                var pillName = ($(this).attr('data-name') || '').toLowerCase();
                var pillNameElement = $(this).find('.pill-name');
                var originalPill = pillNameElement.attr('data-original') || pillNameElement.text();
                if(!query || pillName.includes(query)){
                    pillNameElement.html(query ? highlightMatch(originalPill, escaped) : originalPill);
                    $(this).show();
                    hasVisibleTop = true;
                } else {
                    pillNameElement.html(originalPill);
                    $(this).hide();
                }
            });

            // Show 'No matching tags found.' message if applicable
            if(query.length > 0 && !hasVisibleTags){
                if($('#tag-list .no-results').length === 0){
                    $('#tag-list').append('<li class="no-tags-message no-results">No matching tags found.</li>');
                }
            } else {
                $('#tag-list .no-tags-message.no-results').remove();
            }
        }

        // Event listener for search input with debounce
        $('#tag-search').on('input', debounce(function(){
            applyFilter($(this).val());
        }, 300));

        // Apply filter on load if there's prefilled value (e.g., back navigation)
        applyFilter($('#tag-search').val());
    });
</script>
{% endblock %}
